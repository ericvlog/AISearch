<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Configure AI Movie Finder</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-900 text-gray-100 min-h-screen flex flex-col items-center justify-center p-4">
    <!-- Description Section -->
    <div class="w-full max-w-lg bg-gray-800 rounded-lg shadow-lg p-6 mb-6">
      <h1 class="text-2xl font-bold mb-4 text-center">What does this do?</h1>
      <p class="text-gray-300">
        This catalog uses AI to determine what you're looking for. For example, if you search for "Movie where the parents leave the child alone on vacation", it will return "Home Alone" and similar results.
      </p>
    </div>

    <!-- Configuration Section -->
    <div class="w-full max-w-lg bg-gray-800 rounded-lg shadow-lg p-6">
      <h1 class="text-2xl font-bold mb-4 text-center">Configure AI Movie Finder</h1>
      <div class="space-y-4">
        <!-- API Key Section (wrapped for easy hide/show) -->
        <div id="api-key-section">
          <!-- Info Box -->
          <div class="bg-blue-900 border border-blue-700 text-blue-200 p-3 mb-4 rounded">
            <p class="text-sm">
              Your API key is only used on the client side and is not saved by us.
            </p>
          </div>
          <label for="googleKey" class="block text-sm font-medium text-gray-300">
            Google AI Key:
          </label>
          <input
            type="text"
            id="googleKey"
            name="googleKey"
            required
            placeholder="Enter your Google AI key"
            class="w-full p-3 border border-gray-600 rounded-lg bg-gray-700 text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
        </div>

        <!-- Checkbox to use default key -->
        <div class="flex items-center">
          <input
            id="defaultKey"
            name="defaultKey"
            type="checkbox"
            class="mr-2"
          />
          <label for="defaultKey" class="text-sm text-gray-300">
            Use default key
          </label>
        </div>

        <!-- Install Button -->
        <button
          id="install-button"
          class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed"
          disabled
        >
          Install Addon
        </button>
      </div>
    </div>

    <!-- GitHub Link Section with Icon -->
    <footer class="w-full max-w-lg mt-6 text-center">
      <a
        href="https://github.com/mkcfdc/AISearch"
        target="_blank"
        rel="noopener noreferrer"
        class="inline-flex items-center text-blue-400 hover:underline"
      >
        <!-- GitHub SVG Icon -->
        <svg
          class="w-6 h-6 mr-2"
          role="img"
          viewBox="0 0 24 24"
          fill="currentColor"
          xmlns="http://www.w3.org/2000/svg"
        >
          <title>GitHub</title>
          <path d="M12 0C5.373 0 0 5.373 0 12c0 5.302 3.438 9.8 8.205 11.387.6.111.82-.261.82-.577 
          0-.285-.011-1.04-.017-2.04-3.338.724-4.042-1.612-4.042-1.612-.546-1.387-1.333-1.757-1.333-1.757-1.089-.745.083-.729.083-.729 
          1.205.084 1.84 1.236 1.84 1.236 1.07 1.835 2.809 1.304 3.495.997.108-.776.42-1.305.763-1.605-2.665-.3-5.466-1.335-5.466-5.93 
          0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.957-.266 1.98-.399 3-.405 1.02.006 2.043.139 3 
          .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.435.375.81 
          1.11.81 2.235 0 1.61-.015 2.91-.015 3.31 0 .315.21.694.825.576C20.565 21.092 24 16.592 24 12c0-6.627-5.373-12-12-12"/>
        </svg>
        View this project on GitHub
      </a>
    </footer>

    <script>
      // Ewww vanilla javascript.. lame. Where's React when you want it am I right??
      const googleKeyInput = document.getElementById("googleKey");
      const defaultKeyCheckbox = document.getElementById("defaultKey");
      const installButton = document.getElementById("install-button");
      const apiKeySection = document.getElementById("api-key-section");
      const manifestBaseUrl = "ai-stremio-search.mpc.lol";

      function updateButtonState() {
        if (defaultKeyCheckbox.checked) {
          installButton.disabled = false;
        } else {
          installButton.disabled = googleKeyInput.value.trim() === "";
        }
      }

      function isValidGeminiApiKey(key) {
        if (!key) return false;
        if (typeof key !== 'string') return false;
  
        const keyFormat = /^AIza[a-zA-Z0-9_-]{35,39}$/;
        if (!keyFormat.test(key)) return false;
  
        return true;
      }

      googleKeyInput.addEventListener("input", () => {
        if (!defaultKeyCheckbox.checked) updateButtonState();
      });

      defaultKeyCheckbox.addEventListener("change", () => {
        if (defaultKeyCheckbox.checked) {
          apiKeySection.classList.add("hidden");
          googleKeyInput.value = "default";
          googleKeyInput.disabled = true;
        } else {
          apiKeySection.classList.remove("hidden");
          googleKeyInput.value = "";
          googleKeyInput.disabled = false;
        }
        updateButtonState();
      });

      installButton.addEventListener("click", () => {
        let googleKey = googleKeyInput.value.trim();
        if (!googleKey) {
          alert("Please enter your Google AI key.");
          return;
        }
        if (googleKey !== "default" && !isValidGeminiApiKey(googleKey)) {
          alert("Your API key doesn't pass the check. Please verify your key and try again.");
          return;
        }
        const urlWithConfig = `${manifestBaseUrl}/${encodeURIComponent(googleKey)}/manifest.json`;
        window.location.href = `stremio://${urlWithConfig}`;
      });
    </script>
  </body>
</html>